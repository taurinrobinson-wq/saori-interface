<script>
  async function sendToSaori() {
    const inputEl = document.getElementById('userInput');
    const modeEl = document.getElementById('mode');
    const message = inputEl.value.trim();
    const mode = modeEl.value;

    if (!message) return;

    const chatLog = document.getElementById('chatLog');

    const userMsg = document.createElement('div');
    userMsg.className = 'user';
    userMsg.textContent = `You (${mode}): ${message}`;
    chatLog.appendChild(userMsg);

    const { data: { session } } = await supabase.auth.getSession();
    const token = session?.access_token;

    try {
      const res = await fetch('https://gyqzyuvuuyfjxnramkfq.supabase.co/functions/v1/saori', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5cXp5dXZ1dXlmanhucmFta2ZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NjcyMDAsImV4cCI6MjA3MTA0MzIwMH0.4SpC34q7lcURBX4hujkTGqICdSM6ZWASCENnRs5rkS8`
        },
        body: JSON.stringify({ message, mode })
      });

      console.log('Response status:', res.status);

      if (!res.ok) {
        const errorText = await res.text();
        throw new Error(`Saori failed with status ${res.status}: ${errorText}`);
      }

      const data = await res.json();
      console.log('Saori response:', data);

      const saoriMsg = document.createElement('div');
      saoriMsg.className = 'saori';
      saoriMsg.textContent = `Saori: ${data.saoriResponse || 'No response received.'}`;
      chatLog.appendChild(saoriMsg);

      inputEl.value = '';
      chatLog.scrollTop = chatLog.scrollHeight;
    } catch (error) {
      const errorMsg = document.createElement('div');
      errorMsg.className = 'saori';
      errorMsg.textContent = 'Saori could not be reached.';
      chatLog.appendChild(errorMsg);
      console.error('Fetch error:', error);
    }
  }
</script>
